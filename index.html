<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Renuar â€” ××¢×¨×›×ª ××•×¦×¨×™×</title>
  <meta name="description" content="××¢×¨×›×ª × ×™×”×•×œ ××•×¦×¨×™× ×•×—×•×¡×¨×™× â€” Renuar"/>
  <style>
    :root{
      --bg:#0b0e13; --panel:#121824; --muted:#93a1b1; --text:#e8eef6;
      --brand:#1e88e5; --brand2:#0d47a1; --ok:#2e7d32; --warn:#ef6c00; --danger:#e53935;
      --round:18px; --shadow:0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,Helvetica,sans-serif;
      color:var(--text); background: radial-gradient(1200px 600px at 80% -10%, #13203a 0%, transparent 60%) , var(--bg);
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(8px);
      background: rgba(9,12,18,.7);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .bar{
      max-width:1200px; margin:auto; padding:14px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px}
    .brand .dot{width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg,var(--brand),var(--brand2)); box-shadow:0 0 0 4px rgba(30,136,229,.18)}
    nav{display:flex; gap:8px; flex-wrap:wrap}
    .tab{
      border:none; padding:10px 14px; border-radius:999px; color:var(--text); cursor:pointer;
      background:transparent; transition:.25s, transform .15s; font-weight:600;
      border:1px solid rgba(255,255,255,.08)
    }
    .tab[aria-selected="true"]{background:linear-gradient(135deg,var(--brand),var(--brand2)); box-shadow:var(--shadow); transform:translateY(-1px)}
    .wrap{max-width:1200px; margin:24px auto; padding:0 16px}
    .grid{display:grid; grid-template-columns:1fr; gap:18px}
    @media(min-width:980px){ .grid{grid-template-columns: 1.1fr .9fr} }

    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--round); padding:18px; box-shadow:var(--shadow)
    }
    h2{margin:0 0 12px; font-size:1.15rem}
    .row{display:grid; grid-template-columns:1fr; gap:12px}
    @media(min-width:640px){ .row.two{grid-template-columns:1fr 1fr} .row.three{grid-template-columns:1fr 1fr 1fr}}
    label{font-size:.9rem; color:var(--muted)}
    input, textarea, select, button{
      width:100%; border:none; border-radius:12px; padding:12px 14px; font-size:1rem; color:var(--text);
    }
    input, textarea, select{
      background:#0f1420; outline:1px solid rgba(255,255,255,.08);
    }
    input:focus, textarea:focus, select:focus{outline:1px solid var(--brand)}
    textarea{min-height:96px; resize:vertical}
    button{
      background:linear-gradient(135deg,var(--brand),var(--brand2)); font-weight:700; cursor:pointer;
      transition:transform .15s ease, filter .2s ease, box-shadow .2s ease
    }
    button:hover{transform:translateY(-2px); box-shadow:0 8px 22px rgba(30,136,229,.25)}
    .ghost{background:transparent; outline:1px solid rgba(255,255,255,.15)}
    .ok{background:linear-gradient(135deg,#2e7d32,#1b5e20)}
    .warn{background:linear-gradient(135deg,#ef6c00,#e65100)}
    .danger{background:linear-gradient(135deg,#e53935,#c62828)}
    .muted{color:var(--muted)}
    .flex{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .right{margin-inline-start:auto}
    .img-50{width:50px; height:50px; object-fit:cover; border-radius:10px; background:#09101a}
    .tools{display:flex; gap:8px; flex-wrap:wrap}
    .hint{font-size:.85rem; color:var(--muted)}
    .kpi{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    .kpi .card{padding:14px; text-align:center}
    .num{font-size:1.4rem; font-weight:900}
    .table{width:100%; border-collapse:separate; border-spacing:0 8px}
    .table th{font-size:.85rem; color:var(--muted); font-weight:700; text-align:right; padding:0 8px}
    .table td{background:#0f1420; border:1px solid rgba(255,255,255,.06); padding:10px; vertical-align:middle}
    .table tr td:first-child{border-radius:12px 0 0 12px}
    .table tr td:last-child{border-radius:0 12px 12px 0}
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:rgba(255,255,255,.08); font-size:.85rem}
    .lock{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1)}
    .badge{font-size:.8rem; padding:2px 8px; border-radius:999px; background:rgba(255,255,255,.1)}
    .disabled{opacity:.5; pointer-events:none}
  </style>
</head>
<body>
  <header>
    <div class="bar">
      <div class="brand"><span class="dot"></span> Renuar â€” ××¢×¨×›×ª</div>
      <nav>
        <button class="tab" data-tab="products" aria-selected="true">××•×¦×¨×™×</button>
        <button class="tab" data-tab="missing">×—×•×¡×¨×™×</button>
        <button class="tab" data-tab="import">×™×™×‘×•×/×™×™×¦×•×</button>
        <button class="tab" data-tab="about">×¢×œ ×”××¢×¨×›×ª</button>
        <a class="tab" href="https://renuar.co.il" target="_blank" rel="noopener">×œ××ª×¨ Renuar â†—</a>
      </nav>
      <div class="lock">
        <span id="adminState" class="badge">××¦×‘ ×¨×’×™×œ</span>
        <button id="btnAdmin" class="ghost" title="×›× ×™×¡×ª ×× ×”×œ (×¡×™×¡××”: 2154)">ğŸ”’ ××¦×‘ ×× ×”×œ</button>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- KPIs -->
    <div class="kpi">
      <div class="card"><div class="muted">×¡×”×´×› ××•×¦×¨×™×</div><div id="kpiProducts" class="num">0</div></div>
      <div class="card"><div class="muted">×¡×”×´×› ×—×•×¡×¨×™×</div><div id="kpiMissing" class="num">0</div></div>
      <div class="card"><div class="muted">×¢×“×›×•×Ÿ ××—×¨×•×Ÿ</div><div id="kpiUpdated" class="num">â€”</div></div>
    </div>

    <!-- PRODUCTS TAB -->
    <section id="tab-products" class="grid tab-panel cardlike">
      <!-- Ù…Ø±Ø¨Ø¹ ÙÙ„Ø§ØªØ± Ø¹Ø§Ù…Ø© Ù„Ù„Ø¬Ù…ÙŠØ¹ -->
      <div class="card">
        <h2>ğŸ” ×—×™×¤×•×© ××ª×§×“× ×œ×›×•×œ× (×©× / ××—×™×¨)</h2>
        <div class="row three">
          <div>
            <label for="fltName">×©× ××•×¦×¨</label>
            <input id="fltName" placeholder="×—×•×œ×¦×” / ×’×³×™× ×¡ ..."/>
          </div>
          <div>
            <label for="fltPriceMin">××—×™×¨ ××™× ×³ (â‚ª)</label>
            <input id="fltPriceMin" type="number" inputmode="decimal" step="0.01" placeholder="0"/>
          </div>
          <div>
            <label for="fltPriceMax">××—×™×¨ ××§×¡×³ (â‚ª)</label>
            <input id="fltPriceMax" type="number" inputmode="decimal" step="0.01" placeholder="9999"/>
          </div>
        </div>
        <div class="tools" style="margin-top:8px">
          <button id="btnApplyFilters">×”×—×œ ×¡×™× ×•×Ÿ</button>
          <button id="btnResetFilters" class="ghost">××™×¤×•×¡</button>
        </div>
      </div>

      <!-- Ø­Ù‚Ù„ SKU Ù…Ø­Ù…ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙ‚Ø· -->
      <div class="card">
        <h2>ğŸ” ×—×™×¤×•×© ×œ×¤×™ ××§×´×˜ (×œ×× ×”×œ×™× ×‘×œ×‘×“)</h2>
        <div class="row two">
          <div>
            <label for="sku">××§×´×˜</label>
            <input id="sku" placeholder="×œ×“×•×’××”: M250216" disabled title="× ×“×¨×© ××¦×‘ ×× ×”×œ (×¡×™×¡××”: 2154)"/>
          </div>
          <div class="tools" style="align-items:flex-end">
            <button id="btnSkuSearch" class="ghost disabled" title="× ×“×¨×© ××¦×‘ ×× ×”×œ">×—×¤×© ××§×´×˜</button>
            <button id="btnSkuClear" class="ghost">× ×§×”</button>
          </div>
        </div>
        <div id="skuResult" style="margin-top:10px"></div>
        <p class="hint">×¨×§ ×œ××—×¨ ×”×¤×¢×œ×ª <b>××¦×‘ ×× ×”×œ</b> × ×™×ª×Ÿ ×œ×”×§×œ×™×“ ××§×´×˜ ×•×œ×¨××•×ª ×ª×•×¦××•×ª.</p>
      </div>

      <!-- Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ« (Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙŠØªØ·Ù„Ø¨ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±) -->
      <div class="card">
        <h2>ğŸ› ï¸ ×”×•×¡×¤×” / ×¢×“×›×•×Ÿ ×¤×¨×™×˜</h2>
        <div class="row three">
          <div>
            <label for="pCode">××§×´×˜ (×™×™×—×•×“×™)</label>
            <input id="pCode" placeholder="×›××•: M250216"/>
          </div>
          <div>
            <label for="pName">×©× ×”×¤×¨×™×˜</label>
            <input id="pName" placeholder="×—×•×œ×¦×ª ×××‘×¨"/>
          </div>
          <div>
            <label for="pPrice">××—×™×¨ (â‚ª)</label>
            <input id="pPrice" type="number" inputmode="decimal" step="0.01" placeholder="119.90"/>
          </div>
        </div>
        <div class="row two">
          <div>
            <label for="pImg">×ª××•× ×ª ××•×¦×¨ (URL)</label>
            <input id="pImg" placeholder="https://.../image.jpg"/>
          </div>
          <div class="tools" style="align-items:flex-end">
            <button id="btnSave" class="ok" title="×¢×“×›×•×Ÿ ×¤×¨×™×˜ ×“×•×¨×© ×¡×™×¡××”">×©××•×¨ ×¤×¨×™×˜</button>
            <button id="btnReset" class="ghost">××™×¤×•×¡ ×˜×•×¤×¡</button>
          </div>
        </div>
        <p class="hint">×©××™×¨×” ×ª×¢×“×›×Ÿ ×¤×¨×™×˜ ×§×™×™× ×× ×”××§×´×˜ ×›×‘×¨ × ××¦×. <b>×¢×“×›×•×Ÿ ×¤×¨×™×˜</b> ×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×× ×”×œ (×¡×™×¡××”: 2154).</p>
      </div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
      <div class="card">
        <div class="flex" style="justify-content:space-between">
          <h2>ğŸ“¦ ×˜×‘×œ×ª ××•×¦×¨×™×</h2>
          <div class="tools">
            <button id="btnSortCode" class="ghost">××™×™×Ÿ ×œ×¤×™ ××§×´×˜</button>
            <button id="btnSortName" class="ghost">××™×™×Ÿ ×œ×¤×™ ×©×</button>
            <button id="btnSortPrice" class="ghost">××™×™×Ÿ ×œ×¤×™ ××—×™×¨</button>
          </div>
        </div>
        <div class="row">
          <table class="table" id="tbl">
            <thead>
              <tr>
                <th>×ª××•× ×”</th>
                <th>×©×</th>
                <th>××§×´×˜</th>
                <th>××—×™×¨</th>
                <th>×¤×¢×•×œ×•×ª</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- MISSING TAB -->
    <section id="tab-missing" class="grid" hidden>
      <div class="card">
        <h2>âŒ ×”×•×¡×¤×ª ×—×•×¡×¨ ××ª×›×œ×”</h2>
        <div class="row two">
          <div>
            <label for="mText">××” ×—×¡×¨?</label>
            <input id="mText" placeholder="×œ×“×•×’××”: ×©×§×™×•×ª, ××“×‘×§×•×ª, ×§×•×œ×‘×™×..."/>
          </div>
          <div>
            <label for="mQty">×›××•×ª (×œ× ×—×•×‘×”)</label>
            <input id="mQty" type="number" min="0" placeholder="10"/>
          </div>
        </div>
        <div class="row two">
          <div>
            <label for="mNote">×”×¢×¨×”</label>
            <input id="mNote" placeholder="×¡×¤×§/×“×—×™×¤×•×ª ×•×›×•×³"/>
          </div>
          <div class="tools" style="align-items:flex-end">
            <button id="btnAddMissing" class="warn">×”×•×¡×£ ×œ×¨×©×™××ª ×”×—×•×¡×¨×™×</button>
            <button id="btnClearMissing" class="ghost">× ×§×” ×©×“×•×ª</button>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="flex">
          <h2>ğŸ“‹ ×¨×©×™××ª ×—×•×¡×¨×™×</h2>
          <button id="btnPurgeDone" class="ghost right">××—×§ ×©×¡×•×× ×• ×›×˜×•×¤×œ</button>
        </div>
        <div id="missingList"></div>
      </div>
    </section>

    <!-- IMPORT/EXPORT TAB -->
    <section id="tab-import" class="grid" hidden>
      <div class="card">
        <h2>â¬‡ï¸â¬†ï¸ ×™×™×‘×•× / ×™×™×¦×•× × ×ª×•× ×™×</h2>
        <div class="row two">
          <div class="tools">
            <button id="btnExport">×™×™×¦×•× JSON</button>
            <button id="btnExportCSV" class="ghost">×™×™×¦×•× CSV</button>
          </div>
          <div class="tools">
            <input id="fileInput" type="file" accept=".json" style="background:transparent; padding:0"/>
            <button id="btnImport" class="ok">×™×™×‘×•× JSON</button>
          </div>
        </div>
        <p class="hint">×”× ×ª×•× ×™× × ×©××¨×™× ×‘×“×¤×“×¤×Ÿ (localStorage). ×œ×©×™×ª×•×£ ×‘×™×Ÿ ××—×©×‘×™× ×™×© ×œ×™×™×‘×/×œ×™×™×¦×.</p>
      </div>
    </section>

    <!-- ABOUT TAB -->
    <section id="tab-about" class="grid" hidden>
      <div class="card">
        <h2>â„¹ï¸ ×¢×œ ×”××¢×¨×›×ª</h2>
        <p>××¢×¨×›×ª ×§×œ×” ×œ× ×™×”×•×œ ××•×¦×¨×™× ×•×—×•×¡×¨×™×. ×©××™×¨×ª × ×ª×•× ×™× ×‘×“×¤×“×¤×Ÿ, ×ª××™×›×” ××œ××” ×‘× ×™×™×“ ×•×“×¡×§×˜×•×¤.</p>
        <ul>
          <li>×—×™×¤×•×© ×œ×›×•×œ× ×œ×¤×™ ×©×/××—×™×¨</li>
          <li>×—×™×¤×•×© ×œ×¤×™ ××§×´×˜ â€” <b>×œ×× ×”×œ×™× ×‘×œ×‘×“</b></li>
          <li>×”×•×¡×¤×”/×¢×“×›×•×Ÿ â€” ×¢×“×›×•×Ÿ ×“×•×¨×© ×¡×™×¡××”</li>
          <li>×˜×‘×œ×ª ××•×¦×¨×™× ×¢× ×ª××•× ×” ×•××™×•×Ÿ</li>
          <li>×¨×©×™××ª ×—×•×¡×¨×™× ×¢× ×¡×™××•×Ÿ ×›××˜×•×¤×œ</li>
          <li>×™×™×¦×•×/×™×™×‘×•× JSON ×•-CSV</li>
        </ul>
      </div>
    </section>
  </main>

  <!-- ×˜××¤×œ×˜×™× -->
  <template id="rowTmpl">
    <tr>
      <td><img class="img-50" src="" alt=""></td>
      <td class="p-name"></td>
      <td class="p-code"><span class="pill"></span></td>
      <td class="p-price"></td>
      <td>
        <div class="tools">
          <button data-edit class="ghost">×¢×¨×•×š</button>
          <button data-delete class="danger">××—×§</button>
          <button data-copy class="ghost">×”×¢×ª×§ ××§×´×˜</button>
        </div>
      </td>
    </tr>
  </template>

  <template id="missTmpl">
    <div class="card" data-miss>
      <div class="flex" style="justify-content:space-between">
        <div class="flex">
          <input type="checkbox" data-done style="width:auto"/>
          <div>
            <div class="pill" style="margin-inline-start:8px"><span data-text></span></div>
            <div class="muted" style="margin-top:6px"><span data-note></span></div>
          </div>
        </div>
        <div class="flex">
          <span class="pill muted" data-qty></span>
          <button data-del class="danger">××—×§</button>
        </div>
      </div>
    </div>
  </template>

  <script>
  (function(){
    // ====== CONSTANTS ======
    const LS_P = 'renuar_products_v3';
    const LS_M = 'renuar_missing_v3';
    const MAX_PRODUCTS = 22000;
    const ADMIN_PASS = '2154';

    // ====== HELPERS ======
    const $ = s=>document.querySelector(s);
    const $$ = s=>document.querySelectorAll(s);
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); touch(); }
    function load(k,def){ try{ return JSON.parse(localStorage.getItem(k)) ?? def }catch{ return def } }
    function money(x){ return isFinite(+x) ? `â‚ª${(+x).toFixed(2)}` : 'â€”' }
    function touch(){ kpiUpdated.textContent = new Date().toLocaleString('he-IL') }
    function toast(msg){
      const el = document.createElement('div');
      el.textContent = msg;
      Object.assign(el.style,{position:'fixed',bottom:'20px',insetInlineStart:'20px',background:'#0f1420',
        border:'1px solid rgba(255,255,255,.2)',padding:'10px 14px',borderRadius:'12px',zIndex:9999});
      document.body.appendChild(el); setTimeout(()=>el.remove(),1600);
    }
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // ====== STATE ======
    let products = load(LS_P, [
      { code:"M250216", name:"×—×•×œ×¦×ª ×××‘×¨", price:119.90, image:"https://via.placeholder.com/300x300?text=Amber" },
      { code:"GAIMI001", name:"×¡× ×™×§×¨×¡ ×’×™×™××™", price:149.90, image:"https://via.placeholder.com/300x300?text=Gaimi" }
    ]);
    let missing = load(LS_M, []);
    let adminEnabled = false;

    // ====== ELEMENTS ======
    // KPIs
    const kpiProducts = $('#kpiProducts'), kpiMissing = $('#kpiMissing'), kpiUpdated = $('#kpiUpdated');
    // Tabs
    $$('.tab').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        if(btn.hasAttribute('href')) return;
        const id = btn.dataset.tab;
        $$('.tab').forEach(b=>b.setAttribute('aria-selected', b===btn ? 'true':'false'));
        $$('section[id^="tab-"]').forEach(s=>s.hidden = !s.id.endsWith(id));
        playTone(660, 0.05);
      });
    });

    // Admin controls
    const btnAdmin = $('#btnAdmin'), adminState = $('#adminState');
    const sku = $('#sku'), btnSkuSearch = $('#btnSkuSearch'), btnSkuClear = $('#btnSkuClear'), skuResult = $('#skuResult');

    // Filters (for all)
    const fltName = $('#fltName'), fltPriceMin = $('#fltPriceMin'), fltPriceMax = $('#fltPriceMax');
    const btnApplyFilters = $('#btnApplyFilters'), btnResetFilters = $('#btnResetFilters');

    // Product form (save/update protected)
    const pCode = $('#pCode'), pName = $('#pName'), pPrice = $('#pPrice'), pImg = $('#pImg');
    const btnSave = $('#btnSave'), btnReset = $('#btnReset');

    // Table + actions
    const tbody = $('#tbody');
    const btnSortCode = $('#btnSortCode'), btnSortName = $('#btnSortName'), btnSortPrice = $('#btnSortPrice');

    // Missing
    const mText = $('#mText'), mQty = $('#mQty'), mNote = $('#mNote');
    const btnAddMissing = $('#btnAddMissing'), btnClearMissing = $('#btnClearMissing');
    const btnPurgeDone = $('#btnPurgeDone'), missingList = $('#missingList');

    // Import/Export
    const fileInput = $('#fileInput'), btnImport = $('#btnImport'), btnExport = $('#btnExport'), btnExportCSV = $('#btnExportCSV');

    // ====== ADMIN MODE ======
    btnAdmin.addEventListener('click', ()=>{
      if(!adminEnabled){
        const pwd = prompt('×¡×™×¡××ª ×× ×”×œ:');
        if(pwd === ADMIN_PASS){
          adminEnabled = true;
          adminState.textContent = '××¦×‘ ×× ×”×œ ×¤×¢×™×œ';
          $('#adminState').style.background = 'rgba(46,125,50,.3)';
          sku.disabled = false; btnSkuSearch.classList.remove('disabled'); btnSkuSearch.title='';
          toast('âœ”ï¸ ××¦×‘ ×× ×”×œ ×”×•×¤×¢×œ');
          playTone(880, 0.08);
        }else{
          toast('×¡×™×¡××” ×©×’×•×™×”');
          playTone(180, 0.12);
        }
      }else{
        adminEnabled = false;
        adminState.textContent = '××¦×‘ ×¨×’×™×œ';
        $('#adminState').style.background = 'rgba(255,255,255,.1)';
        sku.disabled = true; btnSkuSearch.classList.add('disabled'); btnSkuSearch.title='× ×“×¨×© ××¦×‘ ×× ×”×œ';
        toast('××¦×‘ ×× ×”×œ ×›×•×‘×”');
        playTone(300, 0.06);
      }
    });

    // ====== SOUNDS & BUTTON HOVER ======
    // Add hover/click sounds to all buttons dynamically
    function bindButtonSounds(){
      $$('button').forEach(b=>{
        if(b.dataset.soundBound) return;
        b.dataset.soundBound = '1';
        b.addEventListener('mouseenter', ()=>playTone(520, 0.03));
        b.addEventListener('click', ()=>playTone(720, 0.05));
      });
    }
    bindButtonSounds();

    // ====== KPIs ======
    function setKPIs(){ kpiProducts.textContent = products.length; kpiMissing.textContent = missing.length; if(!kpiUpdated.textContent) touch(); }

    // ====== DRAW TABLE ======
    function drawTable(list=products){
      tbody.innerHTML='';
      const tmpl = $('#rowTmpl');
      list.forEach(p=>{
        const tr = tmpl.content.firstElementChild.cloneNode(true);
        tr.querySelector('img').src = p.image || 'https://via.placeholder.com/100x100?text=No+Image';
        tr.querySelector('img').alt = p.name;
        tr.querySelector('.p-name').textContent = p.name;
        tr.querySelector('.p-code .pill').textContent = p.code;
        tr.querySelector('.p-price').textContent = money(p.price);

        // Edit allowed only in admin (fills form; save is protected)
        tr.querySelector('[data-edit]').onclick = ()=>{
          fillForm(p);
          if(!adminEnabled){ toast('×¢×“×›×•×Ÿ ×¤×¨×™×˜ ×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×× ×”×œ'); playTone(200,0.06); }
        };

        // Delete left Ù„Ù„Ø¬Ù…ÙŠØ¹ (Ø¥Ù† Ø£Ø±Ø¯ØªÙ‡Ø§ Ù…Ø­Ù…ÙŠØ©ØŒ Ù‚Ù„Ù‘ÙŠ Ù„Ø£Ù‚ÙÙ„Ù‡Ø§ Ø£ÙŠØ¶Ù‹Ø§)
        tr.querySelector('[data-delete]').onclick = ()=>{
          if(confirm('×œ××—×•×§ ××ª ×”×¤×¨×™×˜?')){
            products = products.filter(x=>x.code!==p.code); save(LS_P, products); drawTable();
          }
        };
        tr.querySelector('[data-copy]').onclick = ()=>{ navigator.clipboard.writeText(p.code).then(()=> toast('×”×•×¢×ª×§ âœ”ï¸')); };

        tbody.appendChild(tr);
      });
      setKPIs(); bindButtonSounds();
    }

    // ====== FILTERS FOR ALL ======
    function applyFilters(){
      const name = fltName.value.trim().toLowerCase();
      const min = fltPriceMin.value ? +fltPriceMin.value : -Infinity;
      const max = fltPriceMax.value ? +fltPriceMax.value : +Infinity;
      const list = products.filter(p=>{
        const okName = !name || p.name.toLowerCase().includes(name);
        const price = +p.price;
        const okPrice = (price>=min && price<=max);
        return okName && okPrice;
      });
      drawTable(list);
    }
    btnApplyFilters.addEventListener('click', applyFilters);
    btnResetFilters.addEventListener('click', ()=>{ fltName.value=''; fltPriceMin.value=''; fltPriceMax.value=''; drawTable(); });

    // ====== SKU SEARCH (ADMIN ONLY) ======
    function skuSearch(){
      if(!adminEnabled){ toast('× ×“×¨×© ××¦×‘ ×× ×”×œ'); playTone(200,0.06); return; }
      const code = sku.value.trim().toLowerCase();
      skuResult.innerHTML = '';
      if(!code){ return; }
      const exact = products.find(p=>p.code.toLowerCase()===code);
      const res = exact || products.find(p=>p.code.toLowerCase().includes(code));
      if(res){
        const img = res.image || 'https://via.placeholder.com/300x300?text=Product';
        skuResult.innerHTML = `
          <div class="card">
            <div class="flex" style="gap:16px">
              <img src="${img}" alt="${escapeHtml(res.name)}" class="img-50" style="width:90px;height:90px;border-radius:16px">
              <div>
                <div class="pill" style="margin-bottom:6px">${escapeHtml(res.name)}</div>
                <div class="muted">××§×´×˜: <b>${escapeHtml(res.code)}</b></div>
                <div>××—×™×¨: <b>${money(res.price)}</b></div>
              </div>
              <div class="right tools">
                <button class="ghost" id="skuToForm">×”×¢×‘×¨ ×œ×˜×•×¤×¡</button>
              </div>
            </div>
          </div>`;
        $('#skuToForm').onclick = ()=>fillForm(res);
        bindButtonSounds();
      }else{
        skuResult.innerHTML = `<div class="muted">âŒ ××•×¦×¨ ×œ× × ××¦×</div>`;
      }
    }
    $('#btnSkuSearch').addEventListener('click', skuSearch);
    sku.addEventListener('keydown', e=>{ if(e.key==='Enter') skuSearch(); });
    btnSkuClear.addEventListener('click', ()=>{ sku.value=''; skuResult.innerHTML=''; });

    // ====== PRODUCT FORM (SAVE/UPDATE REQUIRES ADMIN) ======
    btnSave.addEventListener('click', ()=>{
      if(!adminEnabled){ toast('×¢×“×›×•×Ÿ ×¤×¨×™×˜ ×–××™×Ÿ ×¨×§ ×‘××¦×‘ ×× ×”×œ'); playTone(200,0.06); return; }

      const code = pCode.value.trim();
      const name = pName.value.trim();
      const price = +pPrice.value;
      const image = pImg.value.trim();

      if(!code || !name || isNaN(price)){ alert('×× × ××œ× ××§×´×˜, ×©× ×•××—×™×¨ ×ª×§×™×Ÿ'); return }

      // capacity check
      const exists = products.findIndex(p=>p.code===code) > -1;
      if(!exists && products.length >= MAX_PRODUCTS){
        alert('×—×¨×™×’×” ××”××’×‘×œ×”: × ×™×ª×Ÿ ×œ×©××•×¨ ×¢×“ 22,000 ×¤×¨×™×˜×™×.');
        return;
      }

      const obj = {code, name, price, image};
      const i = products.findIndex(p=>p.code===code);
      if(i>-1){ products[i]=obj; } else { products.push(obj); }
      save(LS_P, products); drawTable(); fillForm(); alert('âœ”ï¸ × ×©××¨ ×‘×”×¦×œ×—×”');
    });
    btnReset.addEventListener('click', ()=>fillForm());
    function fillForm(p={}){ pCode.value = p.code||''; pName.value = p.name||''; pPrice.value = p.price!=null ? p.price : ''; pImg.value = p.image||''; }

    // ====== TABLE SORT ======
    btnSortCode.onclick = ()=>{ products.sort((a,b)=>a.code.localeCompare(b.code,'he')); save(LS_P, products); drawTable(); };
    btnSortName.onclick = ()=>{ products.sort((a,b)=>a.name.localeCompare(b.name,'he')); save(LS_P, products); drawTable(); };
    btnSortPrice.onclick = ()=>{ products.sort((a,b)=>(+a.price)-(+b.price)); save(LS_P, products); drawTable(); };

    // ====== MISSING LIST ======
    btnAddMissing.addEventListener('click', ()=>{
      const text = mText.value.trim(); const qty = mQty.value? +mQty.value : ''; const note = mNote.value.trim();
      if(!text){ alert('×× × ×›×ª×•×‘ ××” ×—×¡×¨'); return }
      const item = { id: crypto.randomUUID(), text, qty, note, done:false, ts: Date.now() };
      missing.unshift(item); save(LS_M, missing); drawMissing(); mText.value=''; mQty.value=''; mNote.value='';
    });
    btnClearMissing.addEventListener('click', ()=>{ mText.value=''; mQty.value=''; mNote.value=''; });
    btnPurgeDone.onclick = ()=>{
      if(confirm('×œ××—×•×§ ××ª ×›×œ ×”×¤×¨×™×˜×™× ×©×¡×•×× ×• ×›×˜×•×¤×œ?')){
        missing = missing.filter(m=>!m.done); save(LS_M, missing); drawMissing();
      }
    };
    function drawMissing(){
      const list = $('#missingList'); list.innerHTML='';
      const tmpl = $('#missTmpl');
      missing.forEach(m=>{
        const node = tmpl.content.firstElementChild.cloneNode(true);
        node.querySelector('[data-text]').textContent = m.text;
        node.querySelector('[data-qty]').textContent = m.qty!=='' ? `×›××•×ª: ${m.qty}` : '';
        node.querySelector('[data-note]').textContent = m.note || '';
        const cb = node.querySelector('[data-done]'); cb.checked = !!m.done;
        cb.onchange = ()=>{ m.done = cb.checked; save(LS_M, missing); setKPIs(); };
        node.querySelector('[data-del]').onclick = ()=>{
          if(confirm('×œ××—×•×§ ××ª ×”×¨×©×•××”?')){ missing = missing.filter(x=>x.id!==m.id); save(LS_M, missing); drawMissing(); }
        };
        if(m.done){ node.style.opacity=.6 }
        list.appendChild(node);
      });
      setKPIs(); bindButtonSounds();
    }

    // ====== IMPORT/EXPORT ======
    btnExport.onclick = ()=>{
      const data = { products, missing, exportedAt:new Date().toISOString() };
      download('renuar-data.json', JSON.stringify(data, null, 2));
    };
    btnExportCSV.onclick = ()=>{
      const header = ['code','name','price','image'];
      const rows = products.map(p=>[p.code, p.name.replaceAll('"','""'), p.price, p.image]);
      const csv = [header.join(','), ...rows.map(r=>r.map(x=>typeof x==='string' && x.includes(',')?`"${x}"`:x).join(','))].join('\n');
      download('renuar-products.csv', csv);
    };
    btnImport.onclick = ()=>{
      const f = fileInput.files?.[0];
      if(!f){ alert('×‘×—×¨ ×§×•×‘×¥ JSON ×œ×™×™×‘×•×'); return }
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const parsed = JSON.parse(reader.result);
          if(parsed.products){
            if(parsed.products.length > MAX_PRODUCTS){ alert('×”×§×•×‘×¥ ×¢×•×‘×¨ ××ª ××’×‘×œ×ª 22,000 ×¤×¨×™×˜×™×'); return; }
            products = parsed.products;
          }
          if(parsed.missing) missing = parsed.missing;
          save(LS_P, products); save(LS_M, missing);
          drawTable(); drawMissing(); alert('âœ… ×™×•×‘× ×‘×”×¦×œ×—×”');
        }catch(e){ alert('×§×•×‘×¥ ×œ× ×ª×§×™×Ÿ'); }
      };
      reader.readAsText(f);
    };
    function download(name, content){
      const blob = new Blob([content], {type:'application/octet-stream'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = name; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 1000);
    }

    // ====== AUDIO (WebAudio) ======
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    function playTone(freq=600, dur=0.05){
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = 'sine'; o.frequency.value = freq;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(ctx.destination);
      const now = ctx.currentTime;
      g.gain.exponentialRampToValueAtTime(0.08, now+0.01);
      g.gain.exponentialRampToValueAtTime(0.0001, now+dur);
      o.start(); o.stop(now+dur+0.02);
    }

    // ====== INIT ======
    function setInitialAdminUI(){
      // start as normal user
      adminEnabled = false;
      sku.disabled = true;
      btnSkuSearch.classList.add('disabled'); btnSkuSearch.title='× ×“×¨×© ××¦×‘ ×× ×”×œ';
      adminState.textContent = '××¦×‘ ×¨×’×™×œ';
    }

    setInitialAdminUI();
    setKPIs(); drawTable(); drawMissing();
    document.addEventListener('keydown', (e)=>{
      // quick tab shortcuts
      if(e.ctrlKey && e.key==='1') $$('[data-tab]')[0].click();
      if(e.ctrlKey && e.key==='2') $$('[data-tab]')[1].click();
      if(e.ctrlKey && e.key==='3') $$('[data-tab]')[2].click();
      if(e.ctrlKey && e.key==='4') $$('[data-tab]')[3].click();
    });
  })();
  </script>
</body>
</html>
